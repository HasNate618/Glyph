<UserControl x:Class="Glyph.App.UI.KeymapBindingEditor"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             Margin="0,0,0,4">
    <Border CornerRadius="4"
            Background="{DynamicResource CardBackgroundFillColorDefaultBrush}"
            BorderBrush="{DynamicResource ControlStrokeColorDefaultBrush}"
            BorderThickness="1"
            Padding="0">
        <StackPanel>
            <!-- Compact header row: always visible, click to expand -->
            <Grid x:Name="HeaderGrid" Margin="12,8" Cursor="Hand" MouseLeftButtonUp="HeaderGrid_Click">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Expand/Collapse chevron -->
                <ui:SymbolIcon x:Name="ExpandChevron" Grid.Column="0" Symbol="ChevronRight24" FontSize="14" VerticalAlignment="Center" Margin="0,0,8,0" />

                <!-- Key badge -->
                <Border Grid.Column="1" Background="{DynamicResource ControlFillColorDefaultBrush}" CornerRadius="4" Padding="8,3" Margin="0,0,8,0" VerticalAlignment="Center">
                    <TextBlock x:Name="HeaderKeyText" Text="?" FontWeight="SemiBold" FontSize="13" />
                </Border>

                <!-- Label -->
                <TextBlock x:Name="HeaderLabelText" Grid.Column="2" Text="" FontSize="13" VerticalAlignment="Center" Foreground="{DynamicResource TextFillColorSecondaryBrush}" TextTrimming="CharacterEllipsis" />

                <!-- Action type badge -->
                <Border Grid.Column="3" Background="{DynamicResource SubtleFillColorSecondaryBrush}" CornerRadius="4" Padding="6,2" Margin="8,0" VerticalAlignment="Center">
                    <TextBlock x:Name="HeaderActionTypeText" Text="" FontSize="11" Foreground="{DynamicResource TextFillColorTertiaryBrush}" />
                </Border>

                <!-- Delete button -->
                <ui:Button x:Name="DeleteButton" Grid.Column="4" Appearance="Secondary" Padding="4" Width="28" Height="28" VerticalAlignment="Center" Click="DeleteButton_Click" ToolTip="Delete binding">
                    <ui:SymbolIcon Symbol="Delete24" FontSize="14" Foreground="White" />
                </ui:Button>
            </Grid>

            <!-- Expandable detail panel -->
            <StackPanel x:Name="DetailPanel" Visibility="Collapsed" Margin="12,0,12,12">
                <Separator Margin="0,0,0,8" />

                <!-- Key input row -->
                <Grid Margin="0,0,0,8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="80"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock Text="Key:" VerticalAlignment="Center" Grid.Column="0" />
                    <TextBox x:Name="KeyTextBox" Width="100" VerticalAlignment="Center" Margin="0,0,8,0" Grid.Column="1" TextChanged="KeyTextBox_TextChanged" />
                    <Button x:Name="RecordKeyButton" Content="Record" Padding="8,4" Margin="0,0,8,0" Grid.Column="2" Click="RecordKeyButton_Click" />
                    <Button x:Name="UseTokensButton" Content="Use Tokens" Padding="8,4" Grid.Column="3" Visibility="Visible" Click="UseTokensButton_Click" />
                    <Button x:Name="UseKeyButton" Content="Use Key" Padding="8,4" Grid.Column="3" Visibility="Collapsed" Click="UseKeyButton_Click" />
                </Grid>

                <!-- Key tokens row (hidden by default) -->
                <StackPanel x:Name="KeyTokensRow" Orientation="Horizontal" Margin="0,0,0,8" Visibility="Collapsed">
                    <TextBlock Text="Tokens:" VerticalAlignment="Center" Width="80" />
                    <ComboBox x:Name="KeyTokensCombo" Width="200" VerticalAlignment="Center" Margin="0,0,8,0" IsEditable="True" SelectionChanged="KeyTokensCombo_SelectionChanged" LostFocus="KeyTokensCombo_LostFocus" PreviewMouseLeftButtonDown="ComboBox_PreviewMouseLeftButtonDown" />
                </StackPanel>

                <!-- Label row -->
                <Grid Margin="0,0,0,8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="80"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock Text="Label:" VerticalAlignment="Center" Grid.Column="0" />
                    <TextBox x:Name="LabelTextBox" VerticalAlignment="Center" Grid.Column="1" MaxWidth="400" HorizontalAlignment="Left" MinWidth="200" TextChanged="LabelTextBox_TextChanged" />
                </Grid>

                <!-- Action Type Selection -->
                <Grid Margin="0,0,0,8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="80"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock Text="Action:" VerticalAlignment="Center" Grid.Column="0" />
                    <ComboBox x:Name="ActionTypeCombo" Width="200" VerticalAlignment="Center" Grid.Column="1" SelectionChanged="ActionTypeCombo_SelectionChanged" PreviewMouseLeftButtonDown="ComboBox_PreviewMouseLeftButtonDown">
                        <ComboBoxItem Content="action" Tag="action" />
                        <ComboBoxItem Content="send" Tag="send" />
                        <ComboBoxItem Content="type" Tag="type" />
                        <ComboBoxItem Content="exec" Tag="exec" />
                        <ComboBoxItem Content="steps" Tag="steps" />
                        <ComboBoxItem Content="children (layer)" Tag="children" />
                        <ComboBoxItem Content="setTheme" Tag="setTheme" />
                    </ComboBox>
                </Grid>

                <!-- Action-specific inputs -->
                <StackPanel x:Name="ActionInputsPanel" Margin="0,0,0,4">
                    <!-- Action ID input -->
                    <Grid x:Name="ActionIdPanel" Margin="0,0,0,8" Visibility="Collapsed">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="80"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Action ID:" VerticalAlignment="Center" Grid.Column="0" />
                        <ComboBox x:Name="ActionIdCombo" Width="250" VerticalAlignment="Center" Grid.Column="1" IsEditable="True" SelectionChanged="ActionIdCombo_SelectionChanged" PreviewMouseLeftButtonDown="ComboBox_PreviewMouseLeftButtonDown" />
                    </Grid>

                    <!-- Send spec input -->
                    <Grid x:Name="SendPanel" Margin="0,0,0,8" Visibility="Collapsed">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="80"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Key Chord:" VerticalAlignment="Center" Grid.Column="0" />
                        <TextBox x:Name="SendTextBox" Width="300" VerticalAlignment="Center" Grid.Column="1" TextChanged="SendTextBox_TextChanged" />
                        <TextBlock Text="(e.g., Ctrl+C)" Foreground="{DynamicResource TextFillColorTertiaryBrush}" VerticalAlignment="Center" Margin="8,0,0,0" FontSize="11" Grid.Column="2" />
                    </Grid>

                    <!-- Type text input -->
                    <Grid x:Name="TypePanel" Margin="0,0,0,8" Visibility="Collapsed">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="80"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Text:" VerticalAlignment="Top" Grid.Column="0" Margin="0,4,0,0" />
                        <TextBox x:Name="TypeTextBox" Grid.Column="1" MaxWidth="400" HorizontalAlignment="Left" MinWidth="300" TextWrapping="Wrap" AcceptsReturn="True" MinHeight="60" TextChanged="TypeTextBox_TextChanged" />
                    </Grid>

                    <!-- Exec inputs -->
                    <StackPanel x:Name="ExecPanel" Visibility="Collapsed">
                        <Grid Margin="0,0,0,8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="80"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Text="Path:" VerticalAlignment="Center" Grid.Column="0" />
                            <TextBox x:Name="ExecPathTextBox" Grid.Column="1" MaxWidth="350" HorizontalAlignment="Left" MinWidth="250" VerticalAlignment="Center" Margin="0,0,8,0" TextChanged="ExecPathTextBox_TextChanged" />
                            <Button Content="Browse..." Padding="8,4" Grid.Column="2" Click="BrowseExecPath_Click" />
                        </Grid>
                        <Grid Margin="0,0,0,8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="80"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Text="Args:" VerticalAlignment="Center" Grid.Column="0" />
                            <TextBox x:Name="ExecArgsTextBox" Grid.Column="1" MaxWidth="400" HorizontalAlignment="Left" MinWidth="300" VerticalAlignment="Center" TextChanged="ExecArgsTextBox_TextChanged" />
                        </Grid>
                        <Grid Margin="0,0,0,8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="80"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Text="Cwd:" VerticalAlignment="Center" Grid.Column="0" />
                            <TextBox x:Name="ExecCwdTextBox" Grid.Column="1" MaxWidth="350" HorizontalAlignment="Left" MinWidth="250" VerticalAlignment="Center" Margin="0,0,8,0" TextChanged="ExecCwdTextBox_TextChanged" />
                            <Button Content="Browse..." Padding="8,4" Grid.Column="2" Click="BrowseExecCwd_Click" />
                        </Grid>
                    </StackPanel>

                    <!-- Steps panel -->
                    <StackPanel x:Name="StepsPanel" Visibility="Collapsed">
                        <TextBlock Text="Steps (chained actions):" FontWeight="SemiBold" Margin="0,0,0,8" />
                        <StackPanel x:Name="StepsContainer" Margin="12,0,0,8">
                            <!-- Steps will be added here dynamically -->
                        </StackPanel>
                        <Button x:Name="AddStepButton" Content="+ Add Step" Padding="8,4" HorizontalAlignment="Left" Margin="12,0,0,0" Click="AddStepButton_Click" />
                    </StackPanel>

                    <!-- SetTheme input -->
                    <Grid x:Name="SetThemePanel" Margin="0,0,0,8" Visibility="Collapsed">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="80"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="Theme:" VerticalAlignment="Center" Grid.Column="0" />
                        <ComboBox x:Name="ThemeIdCombo" Width="250" VerticalAlignment="Center" Grid.Column="1" IsEditable="True" SelectionChanged="ThemeIdCombo_SelectionChanged" PreviewMouseLeftButtonDown="ComboBox_PreviewMouseLeftButtonDown" />
                    </Grid>
                </StackPanel>

                <!-- Children (Layer) panel -->
                <StackPanel x:Name="ChildrenPanel" Margin="0,4,0,0" Visibility="Collapsed">
                    <TextBlock Text="Nested Bindings (Layer):" FontWeight="SemiBold" Margin="0,0,0,8" />
                    <StackPanel x:Name="ChildrenContainer" Margin="8,0,0,8">
                        <!-- Children bindings will be added here dynamically -->
                    </StackPanel>
                    <Button x:Name="AddChildButton" Content="+ Add Binding" Padding="8,4" HorizontalAlignment="Left" Margin="8,0,0,0" Click="AddChildButton_Click" />
                </StackPanel>
            </StackPanel>
        </StackPanel>
    </Border>
</UserControl>
